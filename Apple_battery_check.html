<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS é›»æ± æ—¥èªŒåˆ†æ </title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #fff;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h2 { margin-bottom: 5px; color: #007aff; }
        .subtitle { font-size: 0.9em; color: #8e8e93; margin-bottom: 20px; }

        /* ä¸Šå‚³å€å¡Šæ¨£å¼ */
        .upload-area {
            border: 2px dashed #c7c7cc;
            border-radius: 12px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafafa;
            position: relative;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #007aff;
            background-color: #f0f8ff;
        }

        .upload-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .upload-text { font-size: 16px; color: #333; font-weight: 500; }
        .upload-sub { font-size: 13px; color: #888; margin-top: 5px; }

        /* éš±è—åŸæœ¬çš„ file inputï¼Œç”¨æ¨£å¼è“‹åœ¨ä¸Šé¢ */
        #fileInput {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .result-box {
            margin-top: 25px;
            display: none;
            background: #f9f9f9;
            border-radius: 16px;
            padding: 20px;
            text-align: left;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { color: #555; }
        .stat-value { font-weight: bold; color: #000; }

        .loading { display: none; margin-top: 15px; color: #007aff; }

    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ é›»æ± æ—¥èªŒåˆ†æå™¨</h2>
    <div class="subtitle">æ”¯æ´ iOS å…¨ç‰ˆæœ¬ãƒ»æª”æ¡ˆä¸Šå‚³æ¨¡å¼</div>

    <div class="upload-area" id="dropZone">
        <span class="upload-icon">ğŸ“„</span>
        <div class="upload-text">é»æ“Šé¸æ“‡æª”æ¡ˆ</div>
        <div class="upload-sub">æ”¯æ´ Analytics æˆ– log-aggregated æª”æ¡ˆ</div>
        <input type="file" id="fileInput" accept=".txt,.ips,.synced,.json">
    </div>

    <div id="loading" class="loading">æ­£åœ¨è®€å–æª”æ¡ˆ...</div>

    <div id="resultArea" class="result-box">
        <div class="stat-item">
            <span class="stat-label">æª”æ¡ˆé¡å‹</span>
            <span class="stat-value" id="logType">--</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">å¾ªç’°æ¬¡æ•¸ (Cycle)</span>
            <span class="stat-value" id="cycleCount">--</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">åŸå§‹æœ€å¤§å®¹é‡</span>
            <span class="stat-value" id="maxCapacity">--</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">å»ºè­°ç‹€æ…‹</span>
            <span class="stat-value" id="healthStatus">--</span>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const resultArea = document.getElementById('resultArea');
    const loading = document.getElementById('loading');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        loading.style.display = 'block';
        resultArea.style.display = 'none';

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            analyzeContent(content);
            loading.style.display = 'none';
        };

        reader.onerror = function() {
            alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼");
            loading.style.display = 'none';
        };

        // è®€å–æª”æ¡ˆå…§å®¹
        reader.readAsText(file);
    });

    function analyzeContent(input) {
        let cycles = null;
        let capacity = null;
        let detectedType = "æœªçŸ¥";

        // æ–°ç‰ˆ iOS (16+) Regex
        const newCycleRegex = /"last_value_CycleCount"\s*:\s*(\d+)/;
        const newCapRegex = /"last_value_MaximumCapacityPercent"\s*:\s*(\d+)/;

        // èˆŠç‰ˆ iOS (15-) Regex
        const oldCycleRegex = /<key>com\.apple\.power\.battery\.CycleCount<\/key>[\s\S]*?<integer>(\d+)<\/integer>/;
        const oldCapRegex = /<key>com\.apple\.power\.battery\.MaximumCapacityPercent<\/key>[\s\S]*?<integer>(\d+)<\/integer>/;

        if (newCycleRegex.test(input)) {
            detectedType = "æ–°ç‰ˆ (Analytics)";
            const cMatch = input.match(newCycleRegex);
            const capMatch = input.match(newCapRegex);
            if (cMatch) cycles = cMatch[1];
            if (capMatch) capacity = capMatch[1];
        } else if (oldCycleRegex.test(input)) {
            detectedType = "èˆŠç‰ˆ (Aggregated)";
            const cMatch = input.match(oldCycleRegex);
            const capMatch = input.match(oldCapRegex);
            if (cMatch) cycles = cMatch[1];
            if (capMatch) capacity = capMatch[1];
        } else {
            alert("ç„¡æ³•åœ¨æª”æ¡ˆä¸­æ‰¾åˆ°é›»æ± æ•¸æ“šï¼Œè«‹ç¢ºèªæ‚¨ä¸Šå‚³çš„æ˜¯æ­£ç¢ºçš„ Analytics æˆ– log-aggregated æª”æ¡ˆã€‚");
            return;
        }

        // æ¸²æŸ“çµæœ
        document.getElementById('logType').textContent = detectedType;
        document.getElementById('cycleCount').textContent = cycles ? cycles + " æ¬¡" : "æœªæ‰¾åˆ°";
        
        const capEl = document.getElementById('maxCapacity');
        const statusEl = document.getElementById('healthStatus');
        
        if (capacity) {
            capEl.textContent = capacity + "%";
            if (parseInt(capacity) >= 80) {
                capEl.style.color = "#34c759";
                statusEl.innerHTML = "<span style='color:#34c759'>å¥åº·</span>";
            } else {
                capEl.style.color = "#ff3b30";
                statusEl.innerHTML = "<span style='color:#ff3b30'>éœ€ç¶­ä¿®</span>";
            }
        } else {
            capEl.textContent = "æœªæ‰¾åˆ°";
            statusEl.textContent = "--";
        }

        resultArea.style.display = 'block';
    }
</script>

</body>
</html>