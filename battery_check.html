<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS å…¨ç‰ˆæœ¬é›»æ± å¥åº·åº¦æª¢æ¸¬ (é€šç”¨ç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #007aff;
        }

        .subtitle {
            text-align: center;
            font-size: 0.85em;
            color: #8e8e93;
            margin-bottom: 20px;
        }

        .instruction {
            font-size: 0.9em;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.6;
            background: #eef1f5;
            padding: 12px;
            border-radius: 8px;
        }

        .instruction code {
            background-color: #d1d1d6;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid #c7c7cc;
            border-radius: 10px;
            font-size: 13px;
            box-sizing: border-box;
            resize: vertical;
            margin-bottom: 15px;
            font-family: monospace; /* ç­‰å¯¬å­—é«”æ–¹ä¾¿çœ‹ log */
        }

        textarea:focus {
            outline: none;
            border-color: #007aff;
        }

        button {
            width: 100%;
            background-color: #007aff;
            color: white;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #005bb5;
        }

        .result-box {
            margin-top: 20px;
            display: none;
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label { color: #555; }
        .stat-value { font-weight: bold; color: #000; }

        .tag-new { background: #e3f2fd; color: #007aff; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .tag-old { background: #fff3e0; color: #ff9800; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

    </style>
</head>
<body>

<div class="container">
    <h2âš¡ï¸ å…¨èƒ½é›»æ± æª¢æ¸¬</h2>
    <div class="subtitle">ğŸ é›»æ± å¥åº·åº¦æª¢æ¸¬</div>
    
    <div class="instruction">
        <strong>ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°æ­£ç¢ºçš„æª”æ¡ˆ</strong><br>
        å‰å¾€ã€Œè¨­å®š > éš±ç§æ¬Š > åˆ†æèˆ‡æ”¹é€²åŠŸèƒ½ > åˆ†æè³‡æ–™ã€<br>
        <ul>
            <li>iOS 16+ (æ–°ç‰ˆ)ï¼šæ‰¾ <code>Analytics-202x...</code></li>
            <li>iOS 15- (èˆŠç‰ˆ)ï¼šæ‰¾ <code>log-aggregated-202x...</code></li>
        </ul>
        <strong>ç¬¬äºŒæ­¥ï¼š</strong>è¤‡è£½å…§å®¹ä¸¦è²¼æ–¼ä¸‹æ–¹ã€‚
    </div>

    <textarea id="logInput" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š Analytics æˆ– log-aggregated çš„å…§å®¹..."></textarea>
    
    <button onclick="analyzeBattery()">é–‹å§‹å…¨é¢åˆ†æ</button>

    <div id="resultArea" class="result-box">
        <h3>æª¢æ¸¬å ±å‘Šï¼š</h3>
        <div class="stat-item">
            <span class="stat-label">æ—¥èªŒæ ¼å¼ç‰ˆæœ¬</span>
            <span class="stat-value" id="logType">--</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">å¾ªç’°æ¬¡æ•¸ (Cycles)</span>
            <span class="stat-value" id="cycleCount">--</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">æœ€å¤§å®¹é‡ (Design %)</span>
            <span class="stat-value" id="maxCapacity">--</span>
        </div>
    </div>
</div>

<script>
    function analyzeBattery() {
        const input = document.getElementById('logInput').value;
        const resultArea = document.getElementById('resultArea');
        const logTypeEl = document.getElementById('logType');
        const cycleEl = document.getElementById('cycleCount');
        const capEl = document.getElementById('maxCapacity');
        
        if (!input.trim()) {
            alert("è«‹å…ˆè²¼ä¸Šæ—¥èªŒå…§å®¹ï¼");
            return;
        }

        let cycles = null;
        let capacity = null;
        let detectedType = "æœªçŸ¥/ç„¡æ³•è¾¨è­˜";

        // --- ç­–ç•¥ Aï¼šé‡å°æ–°ç‰ˆ iOS (16, 17, 18+) ---
        // ç‰¹å¾µï¼šJSON æ ¼å¼ï¼Œé—œéµå­—ç‚º last_value_CycleCount
        const newCycleRegex = /"last_value_CycleCount"\s*:\s*(\d+)/;
        const newCapRegex = /"last_value_MaximumCapacityPercent"\s*:\s*(\d+)/;

        if (newCycleRegex.test(input)) {
            detectedType = '<span class="tag-new">æ–°ç‰ˆ (Analytics)</span>';
            const cycleMatch = input.match(newCycleRegex);
            const capMatch = input.match(newCapRegex);
            
            if (cycleMatch) cycles = cycleMatch[1];
            if (capMatch) capacity = capMatch[1];
        } 
        
        // --- ç­–ç•¥ Bï¼šé‡å°èˆŠç‰ˆ iOS (10 - 15) ---
        // ç‰¹å¾µï¼šXML Plist æ ¼å¼ï¼Œé—œéµå­—è¢« <key> åŒ…è£¹
        // çµæ§‹é€šå¸¸æ˜¯ï¼š <key>...CycleCount</key> (æ›è¡Œ) <integer>123</integer>
        else {
            // ä½¿ç”¨ [\s\S]*? ä¾†åŒ¹é…æ¨™ç±¤ä¸­é–“å¯èƒ½åŒ…å«çš„æ›è¡Œç¬¦è™Ÿ
            const oldCycleRegex = /<key>com\.apple\.power\.battery\.CycleCount<\/key>[\s\S]*?<integer>(\d+)<\/integer>/;
            const oldCapRegex = /<key>com\.apple\.power\.battery\.MaximumCapacityPercent<\/key>[\s\S]*?<integer>(\d+)<\/integer>/;

            if (oldCycleRegex.test(input)) {
                detectedType = '<span class="tag-old">èˆŠç‰ˆ (Aggregated)</span>';
                const cycleMatch = input.match(oldCycleRegex);
                const capMatch = input.match(oldCapRegex);

                if (cycleMatch) cycles = cycleMatch[1];
                if (capMatch) capacity = capMatch[1];
            }
        }

        // --- é¡¯ç¤ºçµæœ ---
        logTypeEl.innerHTML = detectedType;
        
        if (cycles) {
            cycleEl.textContent = cycles + " æ¬¡";
            cycleEl.style.color = "#000";
        } else {
            cycleEl.textContent = "æœªæ‰¾åˆ°æ•¸æ“š";
            cycleEl.style.color = "#999";
        }

        if (capacity) {
            capEl.textContent = capacity + "%";
            // å¥åº·åº¦é¡è‰²æ¨™ç¤º
            if (parseInt(capacity) < 80) {
                capEl.style.color = "#ff3b30"; // ç´…è‰²
                capEl.innerHTML += " (å»ºè­°æ›´æ›)";
            } else {
                capEl.style.color = "#34c759"; // ç¶ è‰²
            }
        } else {
            capEl.textContent = "æœªæ‰¾åˆ°æ•¸æ“š";
            capEl.style.color = "#999";
        }

        resultArea.style.display = 'block';
    }
</script>

</body>
</html>